<!DOCTYPE html>
<html lang="zh">
    <head>
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.3.3 -->

    <!-- Title -->
    
    <title>
        
            Bug3412人工智能停止运行分析报告(初版) | 
        
        Hexo
    </title>

    <!-- Meta & Info -->
    <meta charset="utf-8">

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    

    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="John Doe">
    <meta name="description" content="null">
    <meta name="keywords" content="null,Android">

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/captain_android.jpg">
    <link rel="icon" sizes="192x192" href="/img/captain_android.jpg">
    <link rel="apple-touch-icon" href="/img/captain_android.jpg">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Hexo">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://yoursite.com">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Bug3412人工智能停止运行分析报告(初版) | Hexo">
    <meta property="og:description" content="null">
    <meta property="og:article:tag" content="Android"> 

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import CSS & jQuery -->
    
        <link rel="stylesheet" href="/css/material.min.css">
        <link rel="stylesheet" href="/css/style.min.css">
        <!-- Config CSS -->


<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-image: url(/img/bg.png);
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


        <script src="/js/jquery.min.js"></script>
        <script src="/js/queue.js"></script>
    

    <!-- UC Browser Compatible -->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write("<link rel=\"stylesheet\" href=\"/css/uc.css\">");
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    

    


    <!-- Bing Background -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#简述"><span class="post-toc-number">1.</span> <span class="post-toc-text">简述</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题分析"><span class="post-toc-number">2.</span> <span class="post-toc-text">问题分析</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题来了-为什么没有被清空"><span class="post-toc-number">3.</span> <span class="post-toc-text">问题来了,为什么没有被清空???</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#若你的应用死掉后再起起来-但同时还没有activity的情况下-你将无法操作content-provider"><span class="post-toc-number">4.</span> <span class="post-toc-text">若你的应用死掉后再起起来,但同时还没有activity的情况下, 你将无法操作content provider</span></a></li></ol>

        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script>
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                Bug3412人工智能停止运行分析报告(初版)
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/study-dog.jpg" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>John Doe</strong>
        <span>12月 17, 2016</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/Android/">Android</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=Bug3412人工智能停止运行分析报告(初版)&url=http://yoursite.com//2016/12/17/2016-12-17-Bug3412人工智能停止运行分析报告(初版)/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=Bug3412人工智能停止运行分析报告(初版)&url=http://yoursite.com//2016/12/17/2016-12-17-Bug3412人工智能停止运行分析报告(初版)/index.html&via=John Doe" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com//2016/12/17/2016-12-17-Bug3412人工智能停止运行分析报告(初版)/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://yoursite.com//2016/12/17/2016-12-17-Bug3412人工智能停止运行分析报告(初版)/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    
        <a class="post_share-link" href="http://connect.qq.com/widget/shareqq/index.html?site=Hexo&title=Bug3412人工智能停止运行分析报告(初版)&summary=null&pics=http://yoursite.com/img/captain_android.jpg&url=http://yoursite.com/2016/12/17/2016-12-17-Bug3412人工智能停止运行分析报告(初版)/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 QQ
            </li>
        </a>
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <ul>
<li><h3 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h3></li>
</ul>
<ol>
<li>人工智能的应用是系统级应用,adj值为-15, 在内存不足的情况下,系统也会尽可能不杀死我们的进程,之前我们着手于进程保护的这一方法,后来经过查看aji为-15后,我认为我们的进程退出原因主要是自身程序出错,其调用nlu与msc两个动态库,出错退出是正常的事情.</li>
<li>无限crash原因: 当dialog应用挂掉后,系统有一个监视器,检测到其挂了会立即重新启动. 但是我们的crash发生在启动过程中,因此无限循环下去.</li>
</ol>
<ul>
<li><h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3></li>
</ul>
<p>1.一开始我认为是科大讯飞原因造成的. 其destory方法的确会造成crash, 但这就是造成我们第一次crash的主要原因,在此之后,我们自身的bug引起了无限crash.</p>
<p>2.log日志</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">E/AndroidRuntime( <span class="number">6192</span>): FATAL EXCEPTION: main</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): Process: com.avatar.dialog, PID: <span class="number">6192</span></div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): java.lang.RuntimeException: Unable to create service com.avatar.speech.AvatarSpeechService: java.lang.SecurityException: Unable to find app <span class="keyword">for</span> caller android.app.ApplicationThreadProxy@<span class="number">41992</span>d50 (pid=<span class="number">6192</span>) when getting content provider settings</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at android.app.ActivityThread.handleCreateService(ActivityThread.java:<span class="number">2633</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at android.app.ActivityThread.access$<span class="number">1900</span>(ActivityThread.java:<span class="number">138</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at android.app.ActivityThread$H.handleMessage(ActivityThread.java:<span class="number">1338</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at android.os.Handler.dispatchMessage(Handler.java:<span class="number">102</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at android.os.Looper.loop(Looper.java:<span class="number">136</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at android.app.ActivityThread.main(ActivityThread.java:<span class="number">5101</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at java.lang.reflect.Method.invokeNative(Native Method)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at java.lang.reflect.Method.invoke(Method.java:<span class="number">515</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:<span class="number">811</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">627</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at dalvik.system.NativeStart.main(Native Method)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): Caused by: java.lang.SecurityException: Unable to find app <span class="keyword">for</span> caller android.app.ApplicationThreadProxy@<span class="number">41992</span>d50 (pid=<span class="number">6192</span>) when getting content provider settings</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at android.os.Parcel.readException(Parcel.java:<span class="number">1465</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at android.os.Parcel.readException(Parcel.java:<span class="number">1419</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at android.app.ActivityManagerProxy.getContentProvider(ActivityManagerNative.java:<span class="number">2848</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at android.app.ActivityThread.acquireProvider(ActivityThread.java:<span class="number">4499</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at android.app.ContextImpl$ApplicationContentResolver.acquireProvider(ContextImpl.java:<span class="number">2210</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at android.content.ContentResolver.acquireProvider(ContentResolver.java:<span class="number">1409</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at android.provider.Settings$NameValueCache.lazyGetProvider(Settings.java:<span class="number">890</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at android.provider.Settings$NameValueCache.getStringForUser(Settings.java:<span class="number">937</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at android.provider.Settings$System.getStringForUser(Settings.java:<span class="number">1142</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at android.provider.Settings$System.getString(Settings.java:<span class="number">1126</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at com.avatar.speech.setting.RobotSettings.readRobotNickName(RobotSettings.java:<span class="number">236</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at com.avatar.speech.setting.RobotSettings.init(RobotSettings.java:<span class="number">106</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at com.avatar.speech.setting.RobotSettings.&lt;init&gt;(RobotSettings.java:<span class="number">45</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at com.avatar.speech.AvatarSpeechService.onCreateSpeech(AvatarSpeechService.java:<span class="number">109</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at android.robot.speech.SpeechService.onCreate(SpeechService.java:<span class="number">864</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at com.avatar.speech.AvatarSpeechService.onCreate(AvatarSpeechService.java:<span class="number">53</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	at android.app.ActivityThread.handleCreateService(ActivityThread.java:<span class="number">2623</span>)</div><div class="line">E/AndroidRuntime( <span class="number">6192</span>): 	... <span class="number">10</span> more</div></pre></td></tr></table></figure>
<p>所有的crash都是这个SecurityException, 便去寻找引起SecurityException的原因.</p>
<p>于Android核心类ActivityManagerService中找到<br><br>原因在于 在获取app记录的时候没有获取到<br></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> ContentProviderHolder <span class="title">getContentProviderImpl</span><span class="params">(IApplicationThread caller,</span></span></div><div class="line">           String name, IBinder token, <span class="keyword">boolean</span> stable, <span class="keyword">int</span> userId) &#123;</div><div class="line">       ContentProviderRecord cpr;</div><div class="line">       ContentProviderConnection conn = <span class="keyword">null</span>;</div><div class="line">       ProviderInfo cpi = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">       <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</div><div class="line">           ProcessRecord r = <span class="keyword">null</span>;</div><div class="line">           <span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</div><div class="line">               r = getRecordForAppLocked(caller);     <span class="comment">//在获取app记录的时候没有获取到</span></div><div class="line">               <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</div><div class="line">                           <span class="string">"Unable to find app for caller "</span> + caller</div><div class="line">                         + <span class="string">" (pid="</span> + Binder.getCallingPid()</div><div class="line">                         + <span class="string">") when getting content provider "</span> + name);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">		</div><div class="line">		</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getLRURecordIndexForAppLocked</span><span class="params">(IApplicationThread thread)</span> </span>&#123;</div><div class="line">       IBinder threadBinder = thread.asBinder();</div><div class="line">       <span class="comment">// Find the application record.</span></div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i=mLruProcesses.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</div><div class="line">           ProcessRecord rec = mLruProcesses.get(i);</div><div class="line">           <span class="keyword">if</span> (rec.thread != <span class="keyword">null</span> &amp;&amp; rec.thread.asBinder() == threadBinder) &#123;</div><div class="line">               <span class="keyword">return</span> i;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>而记录是在mLruProcesses中, 通过搜索知道 mLruProcesses 是android用来存放最近每个打开的应用的信息的cache.<br><br>即使被关闭了,也会存在,以此保证下次启动更加迅速.<br><br>此时,困扰很久的问题在于,为什么mLruProcesses会没有我们的记录. <br></p>
<hr>
<p>此时,我认为是我们的应用创建出现了问题, 后来在Application的onCreate中与Service的OnCreate中都加了log,发现一切正常.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">D/DialogApplication( <span class="number">6192</span>): onCreate start</div><div class="line">D/DialogApplication( <span class="number">6192</span>): onCreate end</div><div class="line">D/FakeAIService( <span class="number">6192</span>): onBind</div><div class="line">I/AISupport(  <span class="number">939</span>): mConntction</div><div class="line">W/SpeechManager(  <span class="number">939</span>): getAsrEnable failed: not connected to speech service</div><div class="line">D/AvatarSpeechService( <span class="number">6192</span>): onCreate start</div></pre></td></tr></table></figure>
<p>这个时候没有目标了,一切都正常, 在于为什么没有我们的应用信息呢.前几天我便打开ActivityManagerService的debug,开始看应用挂掉后重启的各项操作.<br><br>同时根据AMS的代码发现,<br><br>在下面方法中会创建app, 获取ProcessRecord app; 初始化app的记录<br></p>
<blockquote>
<p>4891行   private final boolean attachApplicationLocked(IApplicationThread thread,</p>
</blockquote>
<p>创建后通过调用下面的方法来添加进lruProcess中</p>
<blockquote>
<p>updateLruProcessLocked(app, false, null); </p>
</blockquote>
<p>很显然,是在我们添加(刷新)的过程中出现了问题, 我在该方法中加了很多打印,最后发现,在一开始进入的时候<br><br>Android系统会进行判断,若你的进程有activitys,且activity没有变化活动,或者说你有ClientActivities,你都不会被添加进进程记录表中.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">updateLruProcessLocked</span><span class="params">(ProcessRecord app, <span class="keyword">boolean</span> activityChange,</span></span></div><div class="line">        ProcessRecord client) &#123;</div><div class="line">    Slog.i(TAG, <span class="string">"################updateLruProcessLocked: begin"</span>);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> hasActivity = app.activities.size() &gt; <span class="number">0</span> || app.hasClientActivities;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> hasService = <span class="keyword">false</span>; <span class="comment">// not impl yet. app.services.size() &gt; 0;</span></div><div class="line">    <span class="keyword">if</span> (!activityChange &amp;&amp; hasActivity) &#123;</div><div class="line">        <span class="comment">// The process has activties, so we are only going to allow activity-based</span></div><div class="line">        <span class="comment">// adjustments move it.  It should be kept in the front of the list with other</span></div><div class="line">        <span class="comment">// processes that have activities, and we don't want those to change their</span></div><div class="line">        <span class="comment">// order except due to activity operations.</span></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>经过log打印, 发现我们的进程在重新创建后ClientActivities 为true, 竟然没有被清空.</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">I/ActivityManager(  <span class="number">519</span>): ###<span class="selector-id">#new</span> App:ProcessRecord&#123;<span class="number">41</span>b985d0 <span class="number">6192</span>:com<span class="selector-class">.avatar</span><span class="selector-class">.dialog</span>/<span class="number">1000</span>&#125; Activity [] size <span class="number">0</span></div><div class="line">I/ActivityManager(  <span class="number">519</span>): ###<span class="selector-id">#new</span> App:ProcessRecord&#123;<span class="number">41</span>b985d0 <span class="number">6192</span>:com<span class="selector-class">.avatar</span><span class="selector-class">.dialog</span>/<span class="number">1000</span>&#125; App hasClientActivities: true</div></pre></td></tr></table></figure>
<h3 id="问题来了-为什么没有被清空"><a href="#问题来了-为什么没有被清空" class="headerlink" title="问题来了,为什么没有被清空???"></a>问题来了,为什么没有被清空???</h3><p>到Android4.4的源码树下搜索对app.hasClientActivities的操作,发现只有置true, 没有被置false的情况.<br><br>那么为什么没有被置false. 在去Android5.0的源码中搜索,发现竟然有. 同一个方法中, 5.0的系统比4.4特地多添加了一行把该标志位置false的代码</p>
<p>这个方法就是android用来处理应用被干掉后的进程信息清理的,可见,4.4中没有对这个标志位清空.那就标志着<br></p>
<h3 id="若你的应用死掉后再起起来-但同时还没有activity的情况下-你将无法操作content-provider"><a href="#若你的应用死掉后再起起来-但同时还没有activity的情况下-你将无法操作content-provider" class="headerlink" title="若你的应用死掉后再起起来,但同时还没有activity的情况下, 你将无法操作content provider"></a>若你的应用死掉后再起起来,但同时还没有activity的情况下, 你将无法操作content provider</h3><p>当然这个问题应该很少人会遇到.一个没有activity的应用.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Main code for cleaning up a process when it has gone away.  This is</div><div class="line"> * called both as a result of the process dying, or directly when stopping</div><div class="line"> * a process when running in single process mode.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">cleanUpApplicationRecordLocked</span><span class="params">(ProcessRecord app,</span></span></div><div class="line">        <span class="keyword">boolean</span> restarting, <span class="keyword">boolean</span> allowRestart, <span class="keyword">int</span> index) &#123;</div><div class="line">    <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</div><div class="line">        removeLruProcessLocked(app);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mProcessesToGc.remove(app);</div><div class="line">    mPendingPssProcesses.remove(app);</div><div class="line"></div><div class="line">    <span class="comment">// Dismiss any open dialogs.</span></div><div class="line">    <span class="keyword">if</span> (app.crashDialog != <span class="keyword">null</span> &amp;&amp; !app.forceCrashReport) &#123;</div><div class="line">        app.crashDialog.dismiss();</div><div class="line">        app.crashDialog = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (app.anrDialog != <span class="keyword">null</span>) &#123;</div><div class="line">        app.anrDialog.dismiss();</div><div class="line">        app.anrDialog = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (app.waitDialog != <span class="keyword">null</span>) &#123;</div><div class="line">        app.waitDialog.dismiss();</div><div class="line">        app.waitDialog = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    app.crashing = <span class="keyword">false</span>;</div><div class="line">    app.notResponding = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    app.resetPackageList(mProcessStats);</div><div class="line">    app.unlinkDeathRecipient();</div><div class="line">    app.makeInactive(mProcessStats);</div><div class="line">    app.forcingToForeground = <span class="keyword">null</span>;</div><div class="line">    app.foregroundServices = <span class="keyword">false</span>;</div><div class="line">    app.foregroundActivities = <span class="keyword">false</span>;</div><div class="line">    app.hasShownUi = <span class="keyword">false</span>;</div><div class="line">    app.hasAboveClient = <span class="keyword">false</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 当你的应用这个标志不至false的情况下,若你的应用死掉后再起起来,但同时还没有activity的情况下,</div><div class="line">     * 你将无法操作content provider</div><div class="line">     */</div><div class="line">    Slog.v(TAG, <span class="string">"执行死亡后 app 记录清理 + hasClientActivities "</span> +  app.hasClientActivities);</div><div class="line">    app.hasClientActivities = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    mServices.killServicesLocked(app, allowRestart);</div></pre></td></tr></table></figure>

    

    
</div>


                

                <!-- Post Comments -->
                
                    







                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2016/12/03/2016-12-03-Android浅析SurfaceView/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2016/12/19/2016-12-19-Android反编译教程/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/study-dog.jpg" alt="John Doe's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        610315802@qq.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/" target="_self">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2017/04/">四月 2017<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">三月 2017<span class="sidebar_archives-count">12</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/02/">二月 2017<span class="sidebar_archives-count">11</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/01/">一月 2017<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/12/">十二月 2016<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/11/">十一月 2016<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/10/">十月 2016<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/09/">九月 2016<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/08/">八月 2016<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/07/">七月 2016<span class="sidebar_archives-count">8</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/06/">六月 2016<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/09/">九月 2015<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/12/">十二月 2014<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                分类
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/Android/">Android<span class="sidebar_archives-count">27</span></a></li><li><a class="sidebar_archives-link" href="/categories/Blog/">Blog<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/Java/">Java<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/categories/Linux/">Linux<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/View/">View<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/大学那点事/">大学那点事<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/奇技淫巧/">奇技淫巧<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/categories/小知识/">小知识<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/工具类/">工具类<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/漫漫人生路/">漫漫人生路<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/程序员漫画/">程序员漫画<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/categories/网络/">网络<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/设计模式/">设计模式<span class="sidebar_archives-count">10</span></a></li><li><a class="sidebar_archives-link" href="/categories/零散记录/">零散记录<span class="sidebar_archives-count">4</span></a>
            </ul>
        </li>
        
    

    <!-- Pages  -->
    
        <li>
            <a href="/portfolio/index.html" title="About">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                About
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">70</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->


<!-- Theme Material -->


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-gplus.svg);">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/Jerey-Jobs" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.svg);">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;
            <script type="text/javascript">
                var fd = new Date();
                document.write(fd.getFullYear());
            </script>
            &nbsp;Hexo
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->

    <script src="/js/lazyload.min.js"></script>
    <script src="/js/js.min.js"></script>



    <script src="/js/nprogress.js"></script>


<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>
















<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script>
    <!-- Offer LazyLoad -->
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    <!-- Start Queue -->
    $(document).ready(function(){
        setTimeout(function(){
            setInterval(function(){
                queue.execNext();
            },200);
        },3000);
    });
</script>

                </main>
            </div>
        </body>
    
</html>
